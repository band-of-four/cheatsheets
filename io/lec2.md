Лекция 2. Аппаратные интерфейсы вычислительных систем

 # Аппаратные интерфейсы | уровни описания
 
## На физическом уровне определяются:

• Набор сигнальных линий

• Типы соединительных элементов

• Характеристики сигналов

• Нагрузочная способность линий
связи

• Физическая топология

• Максимальная длина линий связи

• Требования к помехоустойчивости
и заземлению

## На логическом уровне определяются:

• Формат пакетов данных

• Логическая топология

• Протокол передачи данных

• Система адресации

_как даются данные, в какой последовательности, порядок взаимодействия ведущего/ведомого_



# Основные характеристики интерфейсов

1. Скорость передачи данных (пропускная способность)

2. Способ передачи слова данных (параллельный,
последовательный)

3. Протяженность линий связи

4. Количество подключаемых устройств

5. Топология

6. Наличие синхронизации (синхронный, асинхронный) 

_никак не относится к типу передачи данных: т.е. синхронный-асинхронны обмен -- при синхронном передатчик знает как работает приемник 
и без задержек или с детерминированными задержками передает данные, не проверя дошли они или нет, потому что он уверен, что данные дошли,
асинхронное -- когдп передатчик не знает, когда готов приемник и поэтому ему надо или опрашивать, или работать по прерыванию_

_в свою очередь, синхронизация в интерфейсах -- это наличие или отсутствие отдельной выделенной линии, которая синхронизирует прием или 
отправку битов данных. Если она есть -- то интерфейс считается синхронным, если нет -- асинхронным_

7. Возможные направления передачи данных
(симплексный, полудуплексный, дуплексный)

_симплексный -- передача в одну сторону, дуплекстный -- в две стороны, полудуплексный -- в две стороны, но по-очереди (с временным мультиплексированием)_



# Типы передаваемых данных

По функциональному
назначению различают:

• Прикладные данные

• Адрес

• Данные управления

Различные типы данных могут
передаваться как на физическом, так
и на логическом уровне.

На физическом уровне для разных
типов данных выделяют отдельные
сигнальные линии.

На логическом уровне для разных
типов данных выделяют
специальные поля на уровне пакетов
передачи данных.

<img src="https://sun9-62.userapi.com/impf/k1x7txl1SfjU7NxLTDZz0NiMpxHiQIcsgSZqjA/dQCIXvSCILI.jpg?size=272x166&quality=96&proxy=1&sign=695ae1d229ec25ff0caee23da145151c&type=album">

1 рисунок:

Все эти данные можно передавать по отдельным лиеиям связи (шина адреса, шина данных, сигналы read/write). При этом увеличивается производительность интерфейса, но это невозможно при передачи данных на большие расстояния, потому что сигналы затухают.

2 рисунок:

Второй способ: перенос всех данныхЫ на другой уровень: управляющий и выше. Тогда между мастером и слейвом будет только одна линия данных, по которой передаются данные. При этом эта линия не разделяется, а парсинг и анализ этих данных идет на приемной стороне, для этого необходимо обозначить протокол для описания того, как передаются данные. 
Плюс: экономия физическиих линий связи.
Минус: усложнение контроллеров интерфейсов ввода-вывода.

Существуют промежуточные варианты, где адрес и сигналы передается по одной линии, а данные -- по другой.

Это упращенное представление: в настоящих шинах передаются всякие метки и другая информация.



# Схемы подключения устройств

<img src="https://sun9-75.userapi.com/impf/LOOnX7kr7bz7ZP37-SlJSEmiUnqu7JIG0bRHAQ/LiUtyStzCLE.jpg?size=1020x363&quality=96&proxy=1&sign=9ae5c5f3dd9f07d6fabbbd88ebf9661e&type=album">


# Виды синхронизации

<img src="https://sun9-60.userapi.com/impf/cREBNnfYPi3JIHegKBxngOU5iNkvd4VB7n3bHg/Ey0orHq6tok.jpg?size=1034x584&quality=96&proxy=1&sign=c69ba00f6681cf04670fd46cc84661eb&type=album">

__Асинхронный интерфейс__ -- это тот интерфейс, который не содержит никакой доп.линии синхронизации и синхронизация осуществляется на протокольном (канальном) уровне при помощи стартовых и стоповых бит, которые позволяют отличить одну посыдку от другой. 

Примеры асинхронных интерфейсов -- RS 232, USB, SATA, PCI Express

__Синхронные интерфейсы__ -- те интерфейсы, в которых есть отдельные линии синхронизации. 

Примеры -- SPI, I2C

Позволяет передавать на больше расстояния -- асинхронные, потому что не нужно поддерживать в стабильном уровне сигнал синхронизации. При этом помехи принято обнаруживать просто при помощи помехоустойчивых кодов.

Позволяет передавать с большей скоростью -- синхронные, потому что не нужно передавать дополнительные биты (стартовые, стоповые, доп биты из-за помехоустойчевого кодирования). Кроме того, могут быть больше частоты.



# Интерфейс I2C

__I²C (Inter Integrated Circuit)__ -- последовательная шина
данных для связи интегральных схем, использующая две
двунаправленные линии связи (SDA _по которому шлются данные_ и SCL _для синхронизации_). 

<img src="https://sun9-11.userapi.com/impf/8aTjlvl7juga51D7WMJu-NaBa-tSr7LkvvwmNg/ESBn6G9-zyI.jpg?size=999x374&quality=96&proxy=1&sign=7470ef8b504bf95427fb211313331dff&type=album">

Используется до сих пор для того, чтобы связывать устройства на материнской плате и передавать данные на которкие растояния.

Подключается по общей шине, поэтому к одной линии можно подключить несколько устройств (в том числе несколько мастеров).

В I2C используется, как правило, однотактный выход с внешней нагрузкой (на картинке видно, что резисторы стоят вне). Двухтактиный нельзя использовать потому что он на выход подает сильную единицу и сильный нуль, и если кто-то еще, подключенный к этой линии, внезапно поставит на ней сигнал другой полярности, получится короткое замыкание, так как будут подключены точки с разным потенциалом. 
Однотактный с _внутренней_ нагрузкой может быть подключен, если мы сопрягаем устройства, которые работают на одинаковых напряжениях питания и при этом понятен уровень сигнала логической единицы.
Для того, чтобы не завязываться на напряжении подключают _однотактный выход с внешней нагрузкой_, подтягивающими резисторами оно будет подтягиваться к одинаковым, ожидаемым значениям. 


## Характеристики интерфейса I2C

- Полудуплексный канал передачи данных

- Количество сигнальных линий: 2

- Роли устройств: ведущий, ведомый

- Поддерживается режим работы с
множеством ведущих (на практике не используется)

- Синхронный интерфейс



## I2C | подключение ведомых по схеме монтажного И

<img src="https://sun9-8.userapi.com/impf/FnYROXVVWIi802JQG--0PVu0CFa-mOQgL9W3mg/bK2DBnW32YI.jpg?size=914x492&quality=96&proxy=1&sign=7b58f693d7d86998f105d83046f1cf3c&type=album">

 __подключение ведомых по схеме монтажного И__ -- если один из ведомых устройств опускает линию в 0, тогда все, независимо от того, что передают, слушают 0 на линии.Единица создается одним источником, а для нуля есть множество источников и они не конфликтуюют друг с другом.
 
 <img src="https://sun9-46.userapi.com/impf/Ts-X0UcOvYx4SQy4VcRaX9Io5_-f0O-T6XAUqQ/0D4CpyzfMkQ.jpg?size=948x495&quality=96&proxy=1&sign=00b5974e407f0d9f1af02d55229c0d9b&type=album">
 
 
 ## I2C | протокол передачи данных 
 
 <img src="https://sun9-46.userapi.com/impf/Ts-X0UcOvYx4SQy4VcRaX9Io5_-f0O-T6XAUqQ/0D4CpyzfMkQ.jpg?size=948x495&quality=96&proxy=1&sign=00b5974e407f0d9f1af02d55229c0d9b&type=album">
 
  целом, в синхронных устройствах используются 2 типа передачи данных -- либо данные валидные в момент уровня сигнала синхронизации (как на картинке), либо в сосент фронта сигнала (в момент перепада).
  
  
  <img src="https://sun9-44.userapi.com/impf/SorcFWxz8B1hFUzpX_rfy-UzdzNZBjKrlAX6VQ/9xHKhbIxMMo.jpg?size=1044x428&quality=96&proxy=1&sign=482ebdd75228b8356c19a102b64e8b77&type=album">
  
  Здесь видны стартовые и стоповые сигналы для увеличения вероятности начала распознования данных и конца. После каждых 8-ми бит идет подтверждение (ACK).  Приемник может принудительно перевести передатчик в 0, для того, чтобы приемник подождал. Это обеспечивается соединение устройств по монтажному И.
  
 ## Состояния СТАРТ и СТОП (1)

__состояние СТАРТ:__ переход сигнала линии SDA из ВЫСОКОГО состояния
в НИЗКОЕ при ВЫСОКОМ уровне на линии SCL.

__состояние СТОП:__ переход состояния линии SDA из низкого состояния
в ВЫСОКОЕ при ВЫСОКОМ состоянии линии SCL


<img src="https://sun9-2.userapi.com/impf/TgeKSjQ4c5a0oSSjDeiMtZQhVupS2-T0RGZePg/lFdTx3nSe5o.jpg?size=1028x476&quality=96&proxy=1&sign=265781b221a263e4bb1d7a247e886e37&type=album">



## Адресация в шине I2C

<img src="https://sun9-24.userapi.com/impf/q55jOQHNUurQMwseyupti6qmMi9_-dydNqGxVQ/Ucn4S8-Yn50.jpg?size=889x450&quality=96&proxy=1&sign=e6806bd89cc25a66d8643b2da03a1adb&type=album">

## Полный формат операции записи

<img src="https://sun9-8.userapi.com/impf/iMbr9PFSxhu6tUdgdEEEM1evu6Mb99fvj3JomQ/3lPUI49SAjk.jpg?size=1051x397&quality=96&proxy=1&sign=0ccd77029a7ead15355e37ae9058e058&type=album">

## Полный формат операции чтения

<img src="https://sun9-52.userapi.com/impf/5CpqU54LLecERoVu4RMVvRje4IHVIT8UFheY2w/GJrP7MKUiV8.jpg?size=951x386&quality=96&proxy=1&sign=c6f2a990fd6e3e3e51a4c4f57844b267&type=album">



## Арбитраж

<img src="https://sun9-11.userapi.com/impf/rpL82K03GCqHdOleTOhhdDeO2sNeYvWx686Olw/xoqd3cThDHs.jpg?size=1017x460&quality=96&proxy=1&sign=f1a6d9debddc1e115baa4656e3798e86&type=album">

2 мастера стараются не использовать, потому что при множестве мастеров возникают гонки сигналов и так как не существует идеальной синхронизации, то на временной диаграмме могут появлятся всплески, которые могут быть расчитаны приемниками, как логические 1.

## I2C | сферы использования

I²C находит применение в устройствах, предусматривающих простоту
разработки и низкую себестоимость изготовления при относительно
неплохой скорости работы.

__Список возможных применений:__

- доступ к модулям памяти;

- доступ к ЦАП/АЦП;

- чтение информации с датчиков мониторинга и
диагностики оборудования, например, термодатчик процессора или
скорость вращения вентилятора охлаждения;

- чтение информации с часов реального времени;

- управление включением/выключением питания системных
компонент;

- информационный обмен между микроконтроллерами.


## Преимущества I2C

- используется всего два проводника для подключения множества
устройств;

- возможна одновременная работа нескольких ведущих ( master )
устройств, подключенных к одной шине I²C.


## Недостатки I2C

- программирование контроллера I²C затруднено из за возможных
нештатных ситуаций на шине.


# Интерфейс SPI

<img src="https://sun9-39.userapi.com/impf/uZ0Vdi7KV_q9gPZ5W5NP2uccG6AwoCi2QQohRQ/SAWG1kz54H0.jpg?size=928x272&quality=96&proxy=1&sign=7bfc352e0a0fdfcdaa20cfc050379d20&type=album">

Cинхронный интерфейс с отдельными линиями для передачии от мастера к слэйву и обратно. SCLK -- линия синхрознизации, SS -- slave select (можно считать линией адреса), MISO -- master input slave output, MOSI -- master output slave input.

Какой тип порта используется для SPI? двухтактный, потому что подключение точка-точка (или кольцо, звезда) требует сильного сигнала и не требует предоставления доступа по шине.

## Характеристики интерфейса

- Направление передачи данных: полный дуплекс

- Роли устройств: ведущий, ведомый

- Количество сигнальных линий: 4

- Синхронный

- Последовательная передача данных

## SPI | протокол передачи данных

<img src="https://sun9-29.userapi.com/impf/2yFAbZFKSs61gZavwVnv9P38Dl1Mz9iujgQjRw/0dLRJDj6nfI.jpg?size=1002x494&quality=96&proxy=1&sign=29ca15c332f9e664f0c1b776ee078834&type=album">

Здесь считываются или записываются данные по фронту синхросигнала: либо по переднему, либо по заднему. Это обычно настраивается: как правила ведущие (master) устройства поддерживают все варианты, а ведомые для упрощения контроллеров поддерживают только один (или несколько) режмов передачи.

Передача данных начинается с того, что SS опускается в 0 и данные могут передаваться произольной длинны и нет никаких сигналов подтверждения.

## SPI | режимы работы

__CPOL ( Clock Polarity )__ -- определяет начальный уровень
(полярность) сигнала синхронизации.

__CPHA ( Clock Phase )__ -- фаза синхронизации, определяет по
какому из фронтов синхронизирующего сигнала
производить выборку данных.

<img src="https://sun9-74.userapi.com/impf/pptDK33uodIrAOAlNfy6nsm5neh3AyUGwu0Mnw/I6xyIlxPGGc.jpg?size=556x282&quality=96&proxy=1&sign=40fc347174a4a7dd9e433d49b2bd88df&type=album">

## SPI | схемы подключения ведомых

<img src="https://sun9-53.userapi.com/impf/e_SeK5dlqfws_XKXEedcZk5dtcH3uUes3V8kKQ/0Da6zxiuncU.jpg?size=1093x483&quality=96&proxy=1&sign=0f256469f87997e3d87e675a02c07714&type=album">

Радиальная структура == тип звезда. Естьь много slave'ов и один мастер, который имеет несколько портов на slave select.

Кольцевая структура используется для диагностики или пошагового выполения команд. Кольцо помогает сэкономит количество линий связи и позволяет просто определить с кем есть обмен, а с кем уже нет (чисто физически)

## SPI | схема контроллера

<img src="https://sun9-62.userapi.com/impf/-103TPfpYJ1xRgAL_IaCLaqlKJg-nO9Hevmf8Q/wZEGuTD9q8w.jpg?size=949x393&quality=96&proxy=1&sign=3b059485927ab29564301cdd3e93441c&type=album">

В мастере есть регистр сдвига, который выдвигает данные, которые попадают в регистр сдвига ведомого устройства и то, что вываливается из регистра ведомого попадает в мастер. Такая система справедлива для каких-либо несложных устройств (напр, датчиков температуры), но не справедлива для сложных, например, памяти, в которой нужно передавать и адрес, и взаимодействие с разными ячейками.

## SPI | регистры контроллера

С программной точки зрения работы с контроллером
SPI представляет
собою взаимодействие с регистрами

- Управления контроллером (SPCR)

- Состояния контроллера (spi_done)

- Управления шиной SS
 
- Данных

Все перечисленные регистры должны быть отображены в памяти.

## SPI | регистр управления контроллером

_пример из какой-то книги, как может выглядеть регист управления_

<img src="https://sun9-31.userapi.com/impf/6I4u6y0bRkSoiIorHudSKs79wvqybd1MyzQE2Q/HGIQ-5kCSX4.jpg?size=868x119&quality=96&proxy=1&sign=519333504034ee744cf7396c3f41f6a3&type=album">

- __SPIE__ -- разрешает /запрещает прерывания от модуля SPI. Если бит
установлен в 1, прерывания от SPI разрешены.

- __SPE__ -- включает/выключает модуль SPI. Если бит установлен в 1, модуль
SPI включен.

- __DORD__ -- определяет порядок передачи данных. Когда бит установлен в 1,
содержимое регистра данных передается младшим битом вперед. Когда
бит сброшен, то старшим битом вперед.

- __MSTR__ -- определяет режим работы микроконтроллера. Если бит
установлен в 1, микроконтроллер работает в режиме Master (ведущий).
Если бит сброшен в режиме Slave (ведомый).

- __SPR1__ и __SPR0__ -- определяют частоту тактового сигнала SPI модуля, то есть
скорость обмена. Максимально возможная скорость обмена всегда
указывается в спецификации периферийного устройства.

## SPI | а лгоритм передачи данных

Алгоритм передачи данных выглядит следующим образом:

1) Инициализация сеанса передачи ( SS = 0)

2) Запись байта данных в сдвиговый регистр

3) Ожидание бита готовности ( spi done)

4) Считывание пришедших данных из сдвигового регистра (если
необходимо)

5) Повторить шаг 2, 3 и 4 для последующих байтов данных

6) Окончание сеанса передачи ( SS <- 1)

## Реализация SPI в различных устройствах

Нижеперечисленные свойства интерфейса
SPI зависят от
конкретного периферийного устройства.

- Частота тактового сигнала SCK

- Режим работы (0-3)

- Порядок передачи данных

- Структура пакета данных

## SPI | преимущества

- Полнодуплексная передача данных.

- Возможность произвольного выбора длины пакета,
длина пакета не ограничена восемью битами.

- Простота аппаратной реализации.

- Используется только четыре вывода, что гораздо
меньше, чем для параллельных интерфейсов.

## SPI | недостатки

- Необходимо больше выводов, чем для интерфейса I2C

- Ведомое устройство не может управлять потоком данных.

- Нет подтверждения приема данных со стороны ведомого
устройства (ведущее устройство может передавать
данные «в никуда»).

- Нет определенного стандартом протокола обнаружения
ошибок.


# Интерфейс RS 232

__UART__
(Universal Asynchronous Receiver Transmitter)
устройство поддерживающее передачу данных по
интерфейсу RS-232.

_это название очень глабальное. даже pсi и usb тоже можно отнести сюда отнести, но когда речь идет про uart мы должны понимать, что речь идет про определенный протокол. RS-232 больше интерфейс для связи по каким-то проводам с устройствами, типа модемов_ 

## Характеристики интерфейса:

• Проводной последовательный асинхронный интерфейс

• Дуплексная передача данных

• Кол во линий данных: 2

• Уровень логического нуля: +5 … +15В вне выч . модуля

• Уровень логической единицы: 5 .. 15 В вне выч . модуля

• Макс. скорость передачи данных: до 1Мбит/с (внутри выч .
модуля), до 115 Кбит/с (вне выч. модуля)

## Протокол передачи данных RS-232

<img src="https://sun9-12.userapi.com/impf/VDU6qiCp5mBe3iW0KHnYJciq2u44rUSjB95JRg/BTDJIvcQ8vc.jpg?size=971x476&quality=96&proxy=1&sign=1af658d507cfa757c034f364fee4dca2&type=album">

Есть стартовый и стоповый бит и до 8 бит данных. Какой-либо линии синхронизации нет и все синхронизируется по стартовым-стоповым битам.

## Принципы передачи данных RS-232

• Синхронизация потока данных происходит по
стартовым и стоповым битам, передающимся по
линиям данных

• Передача и прием данных по линиям TXD и RXD
производятся независимо друг от друга

• Максимальный размер данных равен 1 байту

• Передача осуществляется старшим битом вперед ( MSB,
most significant bit

• Приемник и передатчик данных должны иметь
одинаковые настройки (скорость передачи, контроль
четности и т.п.)

## Настраиваемые параметры RS-232

• Длина данных: 4 8 бит

• Контроль четности: чет/нечет

• Скорость обмена данными: 300, 1200, 2400, 4800, 9600,
19200, 38400, 57600, 115200, 230400; 460800; 921600 бод

• Длина стоп бита: 1, 1.5, 2 длительности передачи бита
данных

• Аппаратный контроль потока (использование сигналов
RTS, CTS ): да/нет


## Применение интерфейса RS-232

В настоящее время широко используется протокол передачи данных
интерфейса RS 232 для связи устройств внутри вычислительного модуля,
на физическом уровне используются сигналы с уровнями КМОП логики

Протокол используют для связи вычислительного ядра с устройствами:

• GSM-модемы

• GPS-приемники

• Wi-Fi приемопередатчики с низким энергопотреблением

• Модемы стандарта ZigBee

Также протокол используется
для отладки и тестирования встроенных
систем.

